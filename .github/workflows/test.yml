name: test
on:
  workflow_dispatch:
  pull_request:
concurrency: uses-parallels-key
jobs:
  run:
    runs-on: macos-12
    steps:
      - name: checkout repository
        uses: actions/checkout@v3.0.2
      - name: test mkmacvm
        run: "$GITHUB_WORKSPACE/test"
        env:
          PARALLELS_KEY: ${{ secrets.PARALLELS_KEY }}
      - name: deactivate Parallels Desktop
        if: always()
        run: |
          if [ -e /usr/local/bin/prlsrvctl ]; then
            if ! output="$(/usr/local/bin/prlsrvctl deactivate-license 2>&1)"; then
              if ! echo "$output" | grep 'activation key is invalid' >/dev/null; then
                error="$output"
                error="$error\nYou may be able to deactivate Parallels Desktop at"
                error="$error\nhttps://my.parallels.com""
                echo "$error" >&2
                exit 1
              else
                echo "Unable to deactivate license; Parallels Desktop is already deactivated"
              fi
            else
              echo "$output"
            fi
          else
            error="Unable to deactivate Parallels Desktop: prlsrvctl not found"
            error="$error\nYou may be able to deactivate Parallels Desktop at"
            error="$error\nhttps://my.parallels.com"
            echo "$error" >&2
            exit 1
          fi
